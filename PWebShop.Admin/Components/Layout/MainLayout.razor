@using System.Linq
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using PWebShop.Infrastructure.Identity
@inherits LayoutComponentBase
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager

<div class="appLayout">
    <aside class="sideBar">
        <header class="sideBarHeader">
            <div class="appTitle">PWebShop Admin</div>
        </header>
        <nav class="sideBarNav" aria-label="Main navigation">
            <NavLink class="navItem" href="/" Match="NavLinkMatch.All">
                <span class="navIcon">ğŸ </span>
                <span>Dashboard</span>
            </NavLink>
            <NavLink class="navItem" href="/users">
                <span class="navIcon">ğŸ‘¥</span>
                <span>Users</span>
            </NavLink>
            <NavLink class="navItem" href="/products">
                <span class="navIcon">ğŸ“¦</span>
                <span>Products</span>
            </NavLink>
            <NavLink class="navItem" href="/categories">
                <span class="navIcon">ğŸ—‚ï¸</span>
                <span>Categories</span>
            </NavLink>
            <NavLink class="navItem" href="/orders">
                <span class="navIcon">ğŸ§¾</span>
                <span>Orders</span>
            </NavLink>
        </nav>
        <footer class="profileSection">
            <div class="avatarPlaceholder">@_initials</div>
            <div class="profileDetails">
                <div class="profileName">@_displayName</div>
                <a href="/logout" class="btn btn-sm btn-outline-primary logoutButton">Logout</a>
            </div>
        </footer>
    </aside>

    <div class="contentShell">
        <header class="topBar">
            <div class="pageTitle">Admin dashboard</div>
            <div class="topBarActions">
                <!-- Placeholder for actions -->
            </div>
        </header>

        <main class="contentArea">
            <section class="contentCard">
                @Body
            </section>
        </main>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    [Inject]
    private UserManager<ApplicationUser> UserManager { get; set; } = default!;

    private string _displayName = "User";
    private string _initials = "?";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            var user = await UserManager.GetUserAsync(principal);
            var displayName = GetDisplayName(user, principal.Identity.Name);

            _displayName = displayName;
            _initials = GetInitials(displayName);
        }
    }

    private static string GetDisplayName(ApplicationUser? user, string? identityName)
    {
        if (!string.IsNullOrWhiteSpace(user?.DisplayName))
        {
            return user!.DisplayName!;
        }

        if (!string.IsNullOrWhiteSpace(user?.UserName))
        {
            return user!.UserName!;
        }

        if (!string.IsNullOrWhiteSpace(user?.Email))
        {
            return user!.Email!;
        }

        if (!string.IsNullOrWhiteSpace(identityName))
        {
            return identityName!;
        }

        return "User";
    }

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "?";
        }

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 0)
        {
            return "?";
        }

        var initials = string.Concat(parts.Take(2).Select(p => char.ToUpperInvariant(p[0])));
        return string.IsNullOrWhiteSpace(initials) ? "?" : initials;
    }
}
