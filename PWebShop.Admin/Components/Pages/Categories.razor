@page "/categories"
@using Microsoft.AspNetCore.Authorization
@using PWebShop.Infrastructure.Identity
@attribute [Authorize(Roles = $"{ApplicationRoleNames.Administrator},{ApplicationRoleNames.Employee}")]

@rendermode InteractiveServer

<PageTitle>Categories</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-0">Categories</h3>
        <p class="text-muted mb-0">Manage nested categories with drag & drop and quick actions.</p>
    </div>
    <button class="btn btn-primary" @onclick="() => StartCreate(null)">Add root category</button>
</div>

@if (!string.IsNullOrWhiteSpace(_statusMessage))
{
    <div class="alert alert-success" role="alert">@_statusMessage</div>
}
@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger" role="alert">@_errorMessage</div>
}

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Category tree</h5>
                    <span class="text-muted small">Drag to reorder or nest</span>
                </div>

                @if (_tree.Count == 0)
                {
                    <p class="text-muted mb-0">No categories found. Create your first category to get started.</p>
                }
                else
                {
                    <div class="category-tree">
                        <ul class="list-unstyled mb-0">
                            @foreach (var item in _tree)
                            {
                                @RenderCategoryItem(item, 0)
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Category details</h5>
                    @if (_isEditMode && _editorModel.Id.HasValue)
                    {
                        <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => ConfirmDeleteAsync(_editorModel.Id!.Value)">Delete</button>
                    }
                </div>

                @if (_editorModel is null)
                {
                    <p class="text-muted mb-0">Select a category or create a new one to edit its details.</p>
                }
                else
                {
                    <EditForm Model="_editorModel" OnValidSubmit="SaveAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <InputText class="form-control" @bind-Value="_editorModel.Name" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Display name</label>
                                <InputText class="form-control" @bind-Value="_editorModel.DisplayName" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <InputTextArea class="form-control" @bind-Value="_editorModel.Description" rows="3" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Parent</label>
                                <InputSelect class="form-select" @bind-Value="_editorModel.ParentId">
                                    <option value="">(no parent)</option>
                                    @foreach (var option in _flatCategories)
                                    {
                                        if (option.Id == _editorModel.Id)
                                        {
                                            continue;
                                        }
                                        <option value="@option.Id">@GetIndentedDisplay(option)</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div class="form-check mt-3">
                                    <InputCheckbox class="form-check-input" @bind-Value="_editorModel.IsActive" id="isActive" />
                                    <label class="form-check-label" for="isActive">Active</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <button type="button" class="btn btn-outline-secondary" @onclick="ResetEditor">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</div>

@code {
}
