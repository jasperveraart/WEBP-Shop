@page "/"
@inject CartService CartService

@layout PWebShop.Rcl.Components.Layout.MainLayout
@using PWebShop.Domain.Entities
@using Microsoft.AspNetCore.Components.Forms
@using PWebShop.Rcl.Services

<div class="container my-4">

    <!-- SEARCH + FILTERS --------------------------- -->
    <div class="card mb-3 p-3">
        <div class="row g-3 align-items-end">

            <!-- Search -->
            <div class="col-12 col-md-6">
                <label class="form-label" for="productSearch">Search</label>
                <div class="input-group">
                    <input id="productSearch"
                           class="form-control"
                           type="search"
                           placeholder="Search by name"
                           @bind="SearchTerm" />
                    <button class="btn btn-primary" @onclick="ApplyFilters">Search</button>
                </div>
            </div>

            <!-- Category (with subcategories included) -->
            <div class="col-lg-4 col-md-6">
                <label class="form-label" for="categoryFilter">Category</label>
                <InputSelect id="categoryFilter"
                             class="form-select"
                             @bind-Value="SelectedCategoryId">
                    <option value="">All categories</option>
                    @foreach (var cat in CategoryOptions)
                    {
                        <option value="@cat.Id">@cat.Name</option>

                        @if (cat.Children != null)
                        {
                            @foreach (var sub in cat.Children)
                            {
                                <option value="@sub.Id">-- @sub.Name</option>
                            }
                        }
                    }
                </InputSelect>
            </div>

            <!-- Price Min -->
            <div class="col-lg-2 col-md-3">
                <label class="form-label" for="minPrice">Min Price</label>
                <input id="minPrice"
                       type="number"
                       class="form-control"
                       @bind="MinPrice"
                       placeholder="0" />
            </div>

            <!-- Price Max -->
            <div class="col-lg-2 col-md-3">
                <label class="form-label" for="maxPrice">Max Price</label>
                <input id="maxPrice"
                       type="number"
                       class="form-control"
                       @bind="MaxPrice"
                       placeholder="0" />
            </div>

        </div>
    </div>
    

    <!-- PRODUCT LIST ---------------------------------->
    <div class="row">
        @foreach (var product in PagedProducts)
        {
            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="@GetProductImage(product)" class="card-img-top" alt="@product.Name"
                         style="height:180px; object-fit:cover;">

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@product.Name</h5>
                        <p class="card-text text-truncate">@product.ShortDescription</p>

                        <p class="fw-bold mt-auto">$@product.FinalPrice.ToString("F2")</p>
                        <p class="text-muted small">Available: @product.QuantityAvailable</p>

                        <button class="btn btn-primary w-100 mt-2"
                                @onclick="() => AddToCart(product)">
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>


    <!-- PAGINATION ----------------------------------- -->
    @if (TotalPages >= 1)
    {
        <div class="d-flex justify-content-between align-items-center mt-4">

            <!-- Info -->
            <p class="text-muted mb-0">
                Showing @((Page - 1) * PageSize + 1)
                –
                @(Math.Min(Page * PageSize, FilteredProducts.Count))
                of @FilteredProducts.Count products
            </p>

            <!-- Items per page -->
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted">Per page:</span>

                <select class="form-select w-auto"
                        @bind="PageSize">
                    <option value="8">8</option>
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="48">48</option>
                </select>
            </div>

            <!-- Page buttons -->
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(Page == 1 ? "disabled" : null)">
                        <button class="page-link" @onclick="() => ChangePage(Page - 1)">«</button>
                    </li>

                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        <li class="page-item @(i == Page ? "active" : null)">
                            <button class="page-link" @onclick="() => ChangePage(i)">
                                @i
                            </button>
                        </li>
                    }

                    <li class="page-item @(Page == TotalPages ? "disabled" : null)">
                        <button class="page-link" @onclick="() => ChangePage(Page + 1)">»</button>
                    </li>
                </ul>
            </nav>

        </div>
    }
</div>



@code {
    /* ===============================
       STATE & FILTERS
    ================================= */

    private string SearchTerm { get; set; } = "";
    private int? SelectedCategoryId { get; set; }
    private double? MinPrice { get; set; }
    private double? MaxPrice { get; set; }

    private void ApplyFilters() => StateHasChanged();


    /* ===============================
       PRODUCTS (TEST DATA)
    ================================= */

    private List<Product> Products = new()
    {
        new Product
        {
            Id = 1, Name = "Laptop",
            ShortDescription = "High performance laptop",
            FinalPrice = 1200, QuantityAvailable = 5,
            IsActive = true, Status = ProductStatus.Approved,
            Category = new Category {
                Id = 1, Name = "Electronics",
                Children = new List<Category>{
                    new Category{ Id = 2, Name = "Laptops" },
                    new Category{ Id = 3, Name = "Monitors" }
                }
            },
            CategoryId = 1,
            Images = new List<ProductImage>{ new ProductImage{ Url="https://via.placeholder.com/300x180" } }
        },

        new Product
        {
            Id = 2, Name = "Headphones",
            ShortDescription = "Noise-cancelling headphones",
            FinalPrice = 200, QuantityAvailable = 15,
            IsActive = true, Status = ProductStatus.Approved,
            Category = new Category { Id = 4, Name = "Audio"},
            CategoryId = 4,
            Images = new List<ProductImage>{ new ProductImage{ Url="https://via.placeholder.com/300x180" } }
        }
    };


    /* ===============================
       CATEGORY OPTIONS
    ================================= */

    private List<Category> CategoryOptions =>
        Products
            .Where(p => p.Category != null)
            .Select(p => p.Category!)
            .DistinctBy(c => c.Id)
            .ToList();


    /* ===============================
       FILTERED PRODUCTS
    ================================= */

    private List<Product> FilteredProducts =>
        Products
            .Where(p =>
                string.IsNullOrWhiteSpace(SearchTerm)
                || p.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
            .Where(p =>
                !SelectedCategoryId.HasValue
                || p.CategoryId == SelectedCategoryId.Value
                || p.Category?.ParentId == SelectedCategoryId.Value)
            .Where(p => !MinPrice.HasValue || p.FinalPrice >= MinPrice.Value)
            .Where(p => !MaxPrice.HasValue || p.FinalPrice <= MaxPrice.Value)
            .Where(p => p.IsActive && p.Status == ProductStatus.Approved)
            .ToList();


    /* ===============================
       PAGINATION
    ================================= */

    private int Page { get; set; } = 1;

    private int PageSize
    {
        get => _pageSize;
        set
        {
            _pageSize = value;
            Page = 1; // reset page when page size changes
        }
    }
    private int _pageSize = 12;

    private int TotalPages =>
        (int)Math.Ceiling((double)FilteredProducts.Count / PageSize);

    private IEnumerable<Product> PagedProducts =>
        FilteredProducts
            .Skip((Page - 1) * PageSize)
            .Take(PageSize);

    private void ChangePage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        Page = page;
    }


    /* ===============================
       HELPERS
    ================================= */

    private void AddToCart(Product product)
    {
        CartService.AddToCart(product);
    }


    private string GetProductImage(Product product) =>
        product.Images.FirstOrDefault()?.Url
        ?? "https://via.placeholder.com/300x180";
}
