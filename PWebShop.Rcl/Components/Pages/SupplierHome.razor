@page "/supplier"
@using PWebShop.Domain.Entities
@using PWebShop.Rcl.Components.Layout
@using PWebShop.Rcl.Dtos
@using PWebShop.Rcl.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Supplier")]
@inject SupplierProductService ProductService
@inject NavigationManager Nav

<div class="container py-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Supplier Dashboard</h2>
        <button class="btn btn-primary" @onclick="CreateProduct">
            <i class="bi bi-plus-lg me-2"></i>Add New Product
        </button>
    </div>

    <!-- PRODUCTS GRID -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = null" aria-label="Close"></button>
        </div>
    }

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!AllProducts.Any())
    {
        <div class="text-center py-5">
            <p class="text-muted fs-5">You haven't added any products yet.</p>
            <button class="btn btn-outline-primary mt-3" @onclick="CreateProduct">Get Started</button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var product in AllProducts)
            {
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm border-0 product-card">
                        <div class="position-relative">
                            <img src="@GetImage(product)" class="card-img-top" style="height:200px; object-fit:cover;" alt="@product.Name" />
                            <span class="position-absolute top-0 end-0 m-2 badge @GetStatusBadgeClass(product.Status)">
                                @product.Status
                            </span>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h5 class="fw-bold text-truncate" title="@product.Name">@product.Name</h5>
                            <p class="text-muted small mb-2 text-truncate">@product.ShortDescription</p>
                            <p class="fw-bold text-primary mb-3">$@product.CurrentPrice.ToString("F2")</p>

                            <div class="mt-auto d-flex justify-content-end gap-2">
                                <button class="btn btn-light btn-sm rounded-circle p-2" @onclick="() => EditProduct(product.Id)" title="Edit">
                                    <i class="bi bi-pencil text-primary"></i>
                                </button>
                                <button class="btn btn-light btn-sm rounded-circle p-2" @onclick="() => ShowDeleteModal(product.Id)" title="Delete">
                                    <i class="bi bi-trash text-danger"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

</div>

<!-- DELETE MODAL -->
<DeleteConfirmModal @ref="deleteModal" OnConfirm="DeleteProduct" />

@code {
    private List<SupplierProductSummaryDto> AllProducts = new();
    private bool IsLoading = true;
    private DeleteConfirmModal deleteModal;
    private int productToDelete;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        IsLoading = true;
        try
        {
            AllProducts = await ProductService.GetProductsAsync();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DeleteProduct()
    {
        ErrorMessage = null;
        var result = await ProductService.DeleteProductAsync(productToDelete);
        if (result.Success)
        {
            var product = AllProducts.FirstOrDefault(p => p.Id == productToDelete);
            if (product != null)
            {
                AllProducts.Remove(product);
            }
            deleteModal.Close();
        }
        else
        {
            ErrorMessage = string.IsNullOrWhiteSpace(result.ErrorMessage) ? "Failed to delete product." : result.ErrorMessage;
            // Keep modal open or close it? User might want to see the error.
            // Let's close the modal and show the error on the main page for now, or show it in the modal?
            // The user asked for "error message if you try to delete", usually better on the main screen if the modal closes, 
            // OR keep modal open and show error there. 
            // Given the modal is "Confirm Delete", showing error *after* confirmation usually means closing it and showing alert.
            deleteModal.Close();
        }
    }

    private void ShowDeleteModal(int id)
    {
        productToDelete = id;
        deleteModal.Show();
    }

    private void CreateProduct() => Nav.NavigateTo("/supplier/products/create");
    private void EditProduct(int id) => Nav.NavigateTo($"/supplier/products/edit/{id}");

    private string GetImage(SupplierProductSummaryDto p) => ProductService.GetProductImageUrl(p.MainImageUrl);

    private string GetStatusBadgeClass(ProductStatus status) => status switch
    {
        ProductStatus.Approved => "bg-success",
        ProductStatus.PendingApproval => "bg-warning text-dark",
        ProductStatus.Rejected => "bg-danger",
        _ => "bg-secondary"
    };
}
