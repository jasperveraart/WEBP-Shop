@page "/supplier"
@using PWebShop.Domain.Entities
@using PWebShop.Rcl.Components.Layout   <!-- Assumi che il modal sia qui -->

<div class="container py-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Supplier Dashboard</h2>
        <button class="btn btn-primary" @onclick="CreateProduct">+ Add New Product</button>
    </div>

    <!-- ACTIVE PRODUCTS -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Active Products</h5>
            <span class="badge bg-success">@ActiveProducts.Count</span>
        </div>
        <div class="card-body">

            @if (!ActiveProducts.Any())
            {
                <p class="text-muted">No active products.</p>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var product in ActiveProducts)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="card h-100 shadow-sm">
                                <img src="@GetImage(product)" class="card-img-top" style="height:150px; object-fit:cover;" />

                                <div class="card-body d-flex flex-column">

                                    <h5 class="fw-bold">@product.Name</h5>
                                    <p class="text-muted small mb-1">@product.ShortDescription</p>
                                    <p class="fw-semibold">$@product.FinalPrice.ToString("F2")</p>

                                    <div class="mt-auto d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm w-50" @onclick="() => EditProduct(product.Id)">Edit</button>
                                        <button class="btn btn-outline-danger btn-sm w-50" @onclick="() => ShowDeleteModal(product.Id)">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
    <!-- PENDING APPROVAL -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between">
            <h5 class="mb-0">Pending Approval</h5>
            <span class="badge bg-warning text-dark">@PendingProducts.Count</span>
        </div>
        <div class="card-body">
            @if (!PendingProducts.Any())
            {
                <p class="text-muted">No products waiting approval.</p>
            }
            else
            {
                @foreach (var product in PendingProducts)
                {
                    <div class="border rounded p-3 mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@product.Name</strong>
                            <p class="text-muted small mb-0">@product.ShortDescription</p>
                        </div>
                        <span class="badge bg-warning text-dark">Pending</span>
                    </div>
                }
            }
        </div>
    </div>

    <!-- REJECTED PRODUCTS (OPTIONAL) -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between">
            <h5 class="mb-0">Rejected Products</h5>
            <span class="badge bg-danger">@RejectedProducts.Count</span>
        </div>
        <div class="card-body">
            @if (!RejectedProducts.Any())
            {
                <p class="text-muted">No rejected products.</p>
            }
            else
            {
                @foreach (var product in RejectedProducts)
                {
                    <div class="border rounded p-3 mb-3">
                        <strong>@product.Name</strong>
                        
                    </div>
                }
            }
        </div>
    </div>

</div>

<!-- DELETE MODAL -->
<DeleteConfirmModal @ref="deleteModal" OnConfirm="DeleteProduct" />

@code {
    private List<Product> AllProducts = new()
    {
        new Product {
            Id = 1,
            Name = "Gaming Laptop",
            ShortDescription = "Ryzen 9, RTX 4070",
            FinalPrice = 1499,
            Status = ProductStatus.Approved,
            IsActive = true,
            Images = new(){ new ProductImage{ Url="https://via.placeholder.com/300x150"} }
        },
        new Product {
            Id = 2,
            Name = "Studio Headphones",
            ShortDescription = "High fidelity audio",
            FinalPrice = 299,
            Status = ProductStatus.PendingApproval,
            Images = new(){ new ProductImage{ Url="https://via.placeholder.com/300x150"} }
        }
    };

    private List<Product> ActiveProducts => 
        AllProducts.Where(p => p.Status == ProductStatus.Approved && p.IsActive).ToList();
    
    private List<Product> PendingProducts =>
        AllProducts.Where(p => p.Status == ProductStatus.PendingApproval).ToList();

    private List<Product> RejectedProducts =>
        AllProducts.Where(p => p.Status == ProductStatus.Rejected).ToList();

    [Inject] NavigationManager Nav { get; set; }
    private DeleteConfirmModal deleteModal;
    private int productToDelete;

    private void DeleteProduct(int id)
    {
        Console.WriteLine($"Deleted product {id}");
        // TODO: backend delete
    }

    private void ShowDeleteModal(int id)
    {
        productToDelete = id;
        deleteModal.ProductId = id; // assegni l'ID al modal
        deleteModal.Show();
    }

    private void CreateProduct() => Nav.NavigateTo("/supplier/products/create");
    private void EditProduct(int id) => Nav.NavigateTo($"/supplier/products/edit/{id}");

    private string GetImage(Product p) =>
        p.Images.FirstOrDefault()?.Url ?? "https://via.placeholder.com/300x150";
}
