@page "/profile"
@using PWebShop.Rcl.Dtos
@using PWebShop.Rcl.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthService AuthService
@inject NavigationManager Nav

<AuthorizeView>
    <Authorized Context="authContext">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="fw-bold mb-4">My Profile</h3>

                            @if (IsLoading)
                            {
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            }
                            else if (CurrentUser != null)
                            {
                                @if (!string.IsNullOrEmpty(Message))
                                {
                                    <div class="alert @(IsSuccess ? "alert-success" : "alert-danger")" role="alert">
                                        @Message
                                    </div>
                                }

                                <EditForm Model="UpdateModel" OnValidSubmit="HandleUpdate">
                                    <DataAnnotationsValidator />

                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="text" class="form-control" value="@CurrentUser.Email" disabled />
                                        <div class="form-text">Email cannot be changed.</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Display Name</label>
                                        <InputText @bind-Value="UpdateModel.DisplayName" class="form-control" />
                                    </div>

                                    @if (CurrentUser.IsCustomer)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">Default Shipping Address</label>
                                            <InputTextArea @bind-Value="UpdateModel.DefaultShippingAddress" class="form-control" rows="3" />
                                        </div>
                                    }

                                    @if (CurrentUser.IsSupplier)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label">Company Name</label>
                                            <InputText @bind-Value="UpdateModel.CompanyName" class="form-control" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">VAT Number</label>
                                            <InputText @bind-Value="UpdateModel.VatNumber" class="form-control" />
                                        </div>
                                    }

                                    <div class="d-flex justify-content-end gap-2 mt-4">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </EditForm>

                                <hr class="my-5" />

                                <h4 class="fw-bold mb-3">Change Password</h4>
                                
                                @if (!string.IsNullOrEmpty(PasswordMessage))
                                {
                                    <div class="alert @(IsPasswordSuccess ? "alert-success" : "alert-danger")" role="alert">
                                        @PasswordMessage
                                    </div>
                                }

                                <EditForm Model="ChangePasswordModel" OnValidSubmit="HandleChangePassword">
                                    <DataAnnotationsValidator />

                                    <div class="mb-3">
                                        <label class="form-label">Current Password</label>
                                        <InputText @bind-Value="ChangePasswordModel.CurrentPassword" type="password" class="form-control" />
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">New Password</label>
                                        <InputText @bind-Value="ChangePasswordModel.NewPassword" type="password" class="form-control" />
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 mt-4">
                                        <button type="submit" class="btn btn-warning">Change Password</button>
                                    </div>
                                </EditForm>
                            }
                            else
                            {
                                <div class="alert alert-danger">Failed to load profile.</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container py-5 text-center">
            <p>You must be logged in to view this page.</p>
            <a href="/login" class="btn btn-primary">Login</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private CurrentUserResponseDto? CurrentUser;
    private UpdateProfileRequestDto UpdateModel = new();
    private ChangePasswordRequestDto ChangePasswordModel = new();
    private bool IsLoading = true;
    private string? Message;
    private bool IsSuccess;
    private string? PasswordMessage;
    private bool IsPasswordSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        IsLoading = true;
        CurrentUser = await AuthService.GetCurrentUser();
        
        if (CurrentUser != null)
        {
            UpdateModel = new UpdateProfileRequestDto
            {
                DisplayName = CurrentUser.DisplayName,
                DefaultShippingAddress = CurrentUser.DefaultShippingAddress,
                CompanyName = CurrentUser.CompanyName,
                VatNumber = CurrentUser.VatNumber
            };
        }
        
        IsLoading = false;
    }

    private async Task HandleUpdate()
    {
        Message = null;
        var result = await AuthService.UpdateProfile(UpdateModel);
        
        IsSuccess = result.Success;
        Message = result.Message;

        if (result.Success)
        {
            // Reload profile to ensure we have latest data
            await LoadProfile();
        }
    }

    private async Task HandleChangePassword()
    {
        PasswordMessage = null;
        var result = await AuthService.ChangePassword(ChangePasswordModel);
        
        IsPasswordSuccess = result.Success;
        PasswordMessage = result.Message;

        if (result.Success)
        {
            ChangePasswordModel = new(); // Reset form
        }
    }
}
